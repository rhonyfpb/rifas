<script src="../socket.io/socket.io.js"></script>
<div id="contenedor-rifa" class="{{state estado}}">
	{{> raffle}}
	{{> numbers}}
</div>
<script>
	(function($){
		$.fn.visualizar = function(options) {
			var ganador = options.ganador;
			var falsos = options.falsos;
			return this.each(function() {
				var lista = $(this), i = 0;
				$(".numero, lista", lista).addClass("not-visible");
				return lista;
			});
		}
	}(jQuery));

	var socket = io.connect("/", {
		reconnection: false
	});

	$("#asignar").on("click", function() {
		var seleccion = $("#seleccion").val();
		var asignado = $("#asignado").val();
		if(seleccion && asignado) {
			socket.emit("number change", seleccion, asignado);
		}
	});

	socket.on("number change", function(numero, asignado) {
		$("#" + numero + " .assign").text(asignado);
		$("#seleccion option[value=" + numero + "]").attr("disabled", "disabled");
	});

	socket.on("number payment", function(numero) {
		$("#" + numero + " .payment").text("pagado");
	});

	socket.on("status change", function(status) {
		if(status === "abrir") {
			$("#contenedor-rifa").removeClass().addClass("abierta");
			$("#estado .value").text("abierta");
			$("#seleccion").closest(".control").addClass("visible").removeClass("not-visible");
		} else if(status === "cerrar") {
			$("#contenedor-rifa").removeClass().addClass("cerrada");
			$("#estado .value").text("cerrada");
			$("#seleccion").closest(".control").addClass("not-visible").removeClass("visible");
			$("#grupo-visualizacion").addClass("visible").removeClass("not-visible");
		} else if(status === "generando") {
			$("#contenedor-rifa").removeClass().addClass("generando");
			$("#estado .value").text("generando");
		}
	});

	socket.on("generate number", function(ganador, falsos) {
		$("#grupo-visualizacion .lista-numeros").visualizar({
			ganador: ganador,
			falsos: falsos
		});
	});

	$(document).ready(function() {

		var containerClass = $("#contenedor-rifa").attr("class");
		switch(containerClass) {
			case "esperando":
				$("#seleccion").closest(".control").addClass("not-visible").removeClass("visible");
				$("#grupo-visualizacion").addClass("not-visible").removeClass("visible");
				break;
			case "abierta":
				$("#grupo-visualizacion").addClass("not-visible").removeClass("visible");
				break;
			case "cerrada":
				$("#seleccion").closest(".control").addClass("not-visible").removeClass("visible");
				break;
			case "generando":
				$("#seleccion").closest(".control").addClass("not-visible").removeClass("visible");
				break;
		}

	});
</script>